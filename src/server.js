// The SQL database that we can run queries on
import { apiPost, apiGet } from "./api.js";

// HOST=[host here] PORT=[port here] bun run server.js
const PORT = Bun.env.PORT ?? 3000;
const HOST = Bun.env.HOST ?? "0.0.0.0";

// TODO: do something with these forms
// TODO: um idk

Bun.serve({
    // Listen on all interfaces
    hostname: HOST,
    port: PORT,

    async fetch(req) {
        // The path of each request is locked to within the public folder.
        // Navigating to the root path / will access index.html by default.
        const url = new URL(req.url);

        // Serve static files
        const path = url.pathname === "/" ? "/index.html" : url.pathname;

        // ------------------------------------------- HANDLE DATA MODIFICATION
        if (req.method === "POST") {
            // Determine what format the information we get will be in -
            // Convert the data to a JS object we can do field access on
            const content_type = req.headers.get("content-type") || "";
            const data =
                content_type === "application/json"
                    ? await req.json()
                    : Object.fromEntries(await req.formData());

            try {
                const api_response = await apiPost(url, data);
                if (api_response) return cors(api_response);
            } catch (err) {
                // Just in case we have out-of-band errors
                console.log(`POST ERROR: ${err}`);
                return cors(Response.json(err, { status: 500 }));
            }
        }

        // ----------------------------------------------- HANDLE DATA FETCHING
        if (req.method === "GET") {
            try {
                // If the file exists, serve that file - this also handles the
                // autogenerated posts based on user submissions (as they are
                // created when a user submits something).
                const file = Bun.file(`./public${path}`);
                if (await file.exists()) return cors(new Response(file));

                // API endpoints for fetching data from each SQL table
                const api_response = await apiGet(url);
                if (api_response) return cors(api_response);
            } catch (err) {
                // Just in case we have out-of-band errors
                console.log(`GET ERROR: ${err}`);
                return cors(Response.json(err, { status: 500 }));
            }
        }

        // -------------------------------------------- HANDLE OPTIONS REQUESTS
        if (req.method === "OPTIONS") {
            try {
                const response = await apiOptions();
                if (response) return cors(response);
            } catch (err) {
                // Just in case we have out-of-band errors
                console.log(`OPTIONS ERROR: ${err}`);
                return cors(Response.json(err, { status: 500 }));
            }
        }

        // If nothing above handled the request, send a 404 response
        return cors(new Response("404 not found.", { status: 404 }));
    },
});

// Allow frontend fetches to work cross-origin
function cors(res) {
    const h = res.headers;
    h.set("Access-Control-Allow-Origin", "*");
    h.set("Access-Control-Allow-Methods", "GET,POST,OPTIONS");
    h.set("Access-Control-Allow-Headers", "Content-Type, Authorization");
    return res;
}

// We can access the website at this address:
console.log(`Server running at http://${HOST}:${PORT}`);
